version: "3.8"
services:
  dynamodb:
    image: "amazon/dynamodb-local:latest"
    container_name: TCBLocalDynamoDB
    ports:
      - "8400:8400"
    volumes:
      - dynamodata:/home/dynamodblocal
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath . -port 8400"
    environment:
      - AWS_ACCESS_KEY_ID=ASDF
      - AWS_SECRET_ACCESS_KEY=ASDF
      - AWS_SESSION_TOKEN=""
      - AWS_DEFAULT_REGION=us-east-1
  init-db:
    depends_on:
      - dynamodb
    image: amazon/aws-cli
    environment:
      AWS_ACCESS_KEY_ID: ASDF
      AWS_SECRET_ACCESS_KEY: ASDF
    command: >-
      dynamodb list-tables --region local --endpoint-url http://dynamodb:8400 | grep -q $TABLE
      if [[ $? != 0 ]]; then
        echo 'add table'
        dynamodb create-table
                --region local
                --endpoint-url http://dynamodb:8400
                --table-name TutorChatBot
                --attribute-definitions AttributeName=pk,AttributeType=S AttributeName=sk,AttributeType=S AttributeName=gs1,AttributeType=S
                --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5
                --key-schema AttributeName=pk,KeyType=HASH AttributeName=sk,KeyType=RANGE
                --global-secondary-indexes '
                  [
                    {                    
                      "IndexName": "gs1",
                      "KeySchema": [
                        { "AttributeName": "gs1", "KeyType": "HASH" }
                      ],
                      "Projection": {
                        "ProjectionType": "ALL"
                      },
                      "ProvisionedThroughput": {
                        "ReadCapacityUnits": 1,
                        "WriteCapacityUnits": 1
                      }
                    }
                  ]
                '
      fi

  server:
    container_name: server
    build:
      context: .
      dockerfile: ./docker/server/Dockerfile
    ports:
      - "3000:3000"

volumes:
  dynamodata: {}
